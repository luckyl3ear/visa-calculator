<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Visa Quest: Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* ğŸŒŒ ê²Œì„ ë°°ê²½ ë° ì»¨í…Œì´ë„ˆ */
        body { font-family: 'Jua', sans-serif; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); }
        .app-container { background-color: #ffffff; width: 100%; max-width: 500px; padding: 30px; border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: center; }
        
        /* âœˆï¸ ì§„í–‰ ë°” */
        .progress-container { width: 100%; background: #eee; height: 14px; border-radius: 10px; margin-bottom: 25px; position: relative; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #00d2ff, #3a7bd5); width: 0%; border-radius: 10px; transition: 0.5s; position: relative; }
        .progress-bar::after { content: 'âœˆï¸'; position: absolute; right: -15px; top: -12px; font-size: 24px; }

        /* ğŸ•¹ï¸ ë²„íŠ¼ ë° í€˜ìŠ¤íŠ¸ ë°•ìŠ¤ */
        .question-box { background: #fef9e7; padding: 20px; border-radius: 20px; min-height: 100px; display: flex; align-items: center; justify-content: center; border: 3px solid #f1c40f; font-size: 20px; margin-bottom: 20px; }
        .btn-group { display: flex; gap: 15px; }
        .ox-btn { flex: 1; padding: 25px; font-size: 30px; border-radius: 15px; border: none; cursor: pointer; font-family: 'Jua', sans-serif; transition: 0.1s; position: relative; }
        .ox-btn:active { top: 4px; }
        .btn-o { background: #d4efdf; color: #27ae60; box-shadow: 0 6px 0 #a9dfbf; }
        .btn-x { background: #fadbd8; color: #e74c3c; box-shadow: 0 6px 0 #f1948a; }

        /* ğŸ¤– AI ì±„íŒ… */
        .ai-section { margin-top: 25px; border: 2px solid #3498db; border-radius: 15px; overflow: hidden; background: #ebf5fb; }
        #chat-window { height: 150px; overflow-y: auto; padding: 10px; background: white; text-align: left; font-size: 14px; }
        .chat-input-group { display: flex; padding: 8px; background: white; gap: 5px; }
        #user-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-family: 'Jua'; }
        
        .screen { display: none; }
        .active-screen { display: block; }
        .visa-badge { background: #f39c12; color: white; padding: 10px 20px; border-radius: 20px; font-size: 24px; margin: 15px 0; display: inline-block; }
        .desc { background: #f9f9f9; padding: 15px; border-radius: 10px; text-align: left; line-height: 1.6; margin-bottom: 20px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-family: 'Jua'; font-size: 18px; cursor: pointer; margin-top: 10px; }
        .consult-btn { background: #03c75a; color: white; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="quiz-screen" class="screen active-screen">
        <h2>ğŸ—ºï¸ ë¹„ì ì°¾ê¸° í€˜ìŠ¤íŠ¸</h2>
        <div class="progress-container"><div class="progress-bar" id="progress-bar"></div></div>
        <div class="question-box" id="question-text">í€˜ìŠ¤íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤!</div>
        <div class="btn-group">
            <button class="ox-btn btn-o" onclick="answerQuiz('O')">â­• ì˜ˆ</button>
            <button class="ox-btn btn-x" onclick="answerQuiz('X')">âŒ ì•„ë‹ˆì˜¤</button>
        </div>

        <div class="ai-section">
            <div id="chat-window">AI ë„ìš°ë¯¸: ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”!</div>
            <div class="chat-input-group">
                <input type="text" id="user-input" placeholder="ì§ˆë¬¸ ì…ë ¥..." onkeypress="if(event.keyCode==13) askGemini()">
                <button onclick="askGemini()" style="background:#3498db; color:white; border:none; border-radius:5px; cursor:pointer;">ì „ì†¡</button>
            </div>
        </div>
    </div>

    <div id="result-screen" class="screen">
        <h2>ğŸ‰ ì§„ë‹¨ ì™„ë£Œ!</h2>
        <div class="visa-badge" id="visa-name">ê²°ê³¼</div>
        <div class="desc" id="visa-desc">ì„¤ëª…</div>
        <button id="go-calc-btn" class="btn" style="background:#3498db; color:white; display:none;" onclick="showScreen('calc-screen')">ğŸ“Š F-2-7 ì ìˆ˜ ê³„ì‚°í•˜ê¸°</button>
        <button class="btn consult-btn" onclick="openSMS()">ğŸ’¬ ê¹€ë™í˜„ í–‰ì •ì‚¬ì™€ ë¬¸ì ìƒë‹´</button>
        <button class="btn" style="background:#eee;" onclick="startQuiz()">ğŸ”„ ë‹¤ì‹œ í•˜ê¸°</button>
    </div>

    <div id="calc-screen" class="screen">
        <h2>ğŸ† ì ìˆ˜ ì±Œë¦°ì§€</h2>
        <div style="text-align:left; margin-bottom:10px;">
            ë‚˜ì´: <select id="age"><option value="0">ì„ íƒ</option><option value="25">25~34ì„¸(25)</option><option value="20">40~44ì„¸(20)</option></select><br><br>
            í•™ë ¥: <select id="edu"><option value="0">ì„ íƒ</option><option value="25">ë°•ì‚¬(25)</option><option value="20">ì„ì‚¬(20)</option></select><br><br>
            ì†Œë“(ì›): <input type="number" id="income" placeholder="ì˜ˆ: 45000000">
        </div>
        <button class="btn" style="background:#2ecc71; color:white;" onclick="calculateScore()">ğŸ¯ ê²°ê³¼ í™•ì¸</button>
        <div id="calc-result" style="display:none; margin-top:15px; padding:15px; background:#e8f8f5; border-radius:10px;">
            <h3>ì´ì : <span id="total-score">0</span>ì </h3>
            <p id="calc-msg"></p>
        </div>
        <button class="btn consult-btn" onclick="openSMS()">ğŸ’¬ ê²°ê³¼ë¡œ ë¬¸ì ìƒë‹´</button>
        <button class="btn" style="background:#eee;" onclick="showScreen('result-screen')">ğŸ”™ ëŒì•„ê°€ê¸°</button>
    </div>
</div>

<script>
    const API_KEY = "AIzaSyDESvr-knS2gSz2gTDaKvMXd7dbz17aH4w";
    const logicTree = {
        start: { text: "ê³¼ê±°ì— í•œêµ­ êµ­ì ì„ ê°€ì¡Œì—ˆê±°ë‚˜, ë¶€ëª¨ë‹˜/ì¡°ë¶€ëª¨ë‹˜ ì¤‘ í•œêµ­ êµ­ì ìê°€ ìˆë‚˜ìš”?", O: "res_f4", X: "q_long_stay" },
        q_long_stay: { text: "ì´ë¯¸ í•œêµ­ì— 5ë…„ ì´ìƒ ê±°ì£¼í•˜ì…¨ê³ , ì•ìœ¼ë¡œ í‰ìƒ ì‚´ ê³„íšì¸ê°€ìš”?", O: "res_f5", X: "q_work" },
        q_work: { text: "í•œêµ­ì—ì„œ ì¼ì„ í•´ì„œ ëˆì„ ë²Œ ê³„íšì´ì‹ ê°€ìš”?", O: "q_expert", X: "q_marry" },
        q_expert: { text: "ì „ë¬¸ì§(í•™ì‚¬ ì´ìƒ/ê³ ìˆ™ë ¨ ê¸°ìˆ ) ì¢…ì‚¬ìì´ì‹ ê°€ìš”?", O: "res_f27", X: "res_e9" },
        q_marry: { text: "í•œêµ­ì¸ê³¼ ê²°í˜¼í•˜ì…¨ê±°ë‚˜ ê³§ ê²°í˜¼í•  ì˜ˆì •ì¸ê°€ìš”?", O: "res_f6", X: "res_etc" }
    };

    const results = {
        res_f4: { name: "F-4 (ì¬ì™¸ë™í¬)", desc: "ë™í¬ë¶„ë“¤ì„ ìœ„í•œ ììœ ë¡œìš´ ë¹„ìì…ë‹ˆë‹¤.", showCalc: false },
        res_f5: { name: "F-5 (ì˜ì£¼ê¶Œ)", desc: "ì˜êµ¬ ê±°ì£¼ ë¹„ìì…ë‹ˆë‹¤. ì „ë¬¸ê°€ ìƒë‹´ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.", showCalc: false },
        res_f27: { name: "F-2-7 / E-7", desc: "ìš°ìˆ˜ì¸ì¬ ë¹„ìì…ë‹ˆë‹¤. ì ìˆ˜ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!", showCalc: true },
        res_e9: { name: "E-9 (ë¹„ì „ë¬¸ì·¨ì—…)", desc: "ê³ ìš©í—ˆê°€ì œ ì·¨ì—… ë¹„ìì…ë‹ˆë‹¤.", showCalc: false },
        res_f6: { name: "F-6 (ê²°í˜¼ì´ë¯¼)", desc: "ê²°í˜¼ ì •ì°© ë¹„ìì…ë‹ˆë‹¤.", showCalc: false },
        res_etc: { name: "ìƒì„¸ ìƒë‹´ í•„ìš”", desc: "í–‰ì •ì‚¬ë‹˜ê³¼ ì§ì ‘ ìƒë‹´í•´ë³´ì„¸ìš”.", showCalc: false }
    };

    let currentStep = "start";
    let stepCount = 0;

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
        document.getElementById(id).classList.add('active-screen');
    }

    function startQuiz() {
        currentStep = "start";
        stepCount = 0;
        document.getElementById('progress-bar').style.width = '0%';
        document.getElementById('question-text').innerText = logicTree[currentStep].text;
        showScreen('quiz-screen');
    }

    function answerQuiz(choice) {
        const next = logicTree[currentStep][choice];
        stepCount++;
        document.getElementById('progress-bar').style.width = Math.min(stepCount * 25, 90) + '%';

        if (next.startsWith("res_")) {
            document.getElementById('progress-bar').style.width = '100%';
            setTimeout(() => {
                const res = results[next];
                document.getElementById('visa-name').innerText = res.name;
                document.getElementById('visa-desc').innerHTML = res.desc;
                document.getElementById('go-calc-btn').style.display = res.showCalc ? "block" : "none";
                showScreen('result-screen');
                confetti({ particleCount: 150, spread: 70 });
            }, 500);
        } else {
            currentStep = next;
            document.getElementById('question-text').innerText = logicTree[currentStep].text;
        }
    }

   async function askGemini() {
    const input = document.getElementById('user-input');
    const win = document.getElementById('chat-window');
    const userText = input.value.trim();

    if (!userText) return;

    // ì‚¬ìš©ì ë©”ì‹œì§€ í™”ë©´ì— ì¶”ê°€
    win.innerHTML += `<div style="margin-bottom:8px; text-align:right;"><b>ë‚˜:</b> ${userText}</div>`;
    input.value = "";
    win.scrollTop = win.scrollHeight;

    try {
        // [ìˆ˜ì • í¬ì¸íŠ¸] v1 ì •ì‹ ë²„ì „ ê²½ë¡œ ì‚¬ìš© ë° ìƒì„¸ ì„¤ì • ì¶”ê°€
        const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                contents: [{
                    parts: [{ text: "ë„ˆëŠ” í•œêµ­ ë¹„ì ì „ë¬¸ í–‰ì •ì‚¬ ê¹€ë™í˜„ì˜ AI ë¹„ì„œì•¼. í•œêµ­ ì¶œì…êµ­ ì§€ì¹¨ì„ ë°”íƒ•ìœ¼ë¡œ ì•„ì£¼ ì§§ê³  ì¹œì ˆí•˜ê²Œ ë‹µí•´ì¤˜. ì§ˆë¬¸: " + userText }]
                }],
                generationConfig: {
                    maxOutputTokens: 200,
                    temperature: 0.7
                }
            })
        });

        const data = await response.json();

        // ğŸš¨ êµ¬ê¸€ ì„œë²„ì—ì„œ ë³´ë‚¸ êµ¬ì²´ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸
        if (data.error) {
            console.error("Google API Error:", data.error);
            throw new Error(`${data.error.status}: ${data.error.message}`);
        }

        if (!data.candidates || data.candidates.length === 0) {
            throw new Error("ë‹µë³€ì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì§ˆë¬¸ì„ ë°”ê¿”ë³´ì„¸ìš”.");
        }

        const aiText = data.candidates[0].content.parts[0].text;
        win.innerHTML += `<div style="color:#2980b9; margin-bottom:8px;"><b>AI:</b> ${aiText}</div>`;
        win.scrollTop = win.scrollHeight;

    } catch (e) {
        console.error("Detailed Error:", e);
        // ì‚¬ìš©ìì—ê²Œ êµ¬ì²´ì ì¸ ì—ëŸ¬ ì›ì¸ì„ ë…¸ì¶œí•˜ì—¬ ì§„ë‹¨ ë„ì›€
        win.innerHTML += `<div style="color:red; font-size:11px; margin-bottom:8px;">âš ï¸ ${e.message}</div>`;
        win.scrollTop = win.scrollHeight;
    }
}
    startQuiz();
</script>
</body>
</html>
